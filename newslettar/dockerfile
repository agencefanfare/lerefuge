FROM golang:1.23-alpine AS builder

WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -o newslettar .

FROM alpine:latest

RUN apk --no-cache add ca-certificates tzdata

WORKDIR /app
COPY --from=builder /app/newslettar .

# Install cron
RUN apk add --no-cache dcron

# Create cron job (runs every Sunday at 9 AM)
RUN echo "0 9 * * 0 /app/newslettar >> /var/log/newslettar.log 2>&1" > /etc/crontabs/root

# Create log file
RUN touch /var/log/newslettar.log

CMD crond -f -l 2